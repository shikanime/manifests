apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: shana
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
        - 10.244.0.0/16
    services:
      cidrBlocks:
        - 10.96.0.0/12
  controlPlaneRef:
    apiVersion: controlplane.cluster.x-k8s.io/v1beta1
    kind: RKE2ControlPlaneTemplate
    name: shana
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    kind: HetznerCluster
    name: shana
---
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: RKE2ControlPlaneTemplate
metadata:
  name: shana
spec:
  template:
    spec:
      serverConfig:
        cni: calico
        kubeAPIServer:
          extraArgs:
          - --anonymous-auth=true
        disableComponents:
          kubernetesComponents: [ "cloudController"]
      rolloutStrategy:
        type: "RollingUpdate"
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: HetznerCluster
metadata:
  name: shana
  namespace: default
  annotations:
    cluster.x-k8s.io/managed-by: k0smotron
spec:
  controlPlaneLoadBalancer:
    enabled: false
  controlPlaneEndpoint:
    host: "0.0.0.0"
    port: 6443
  controlPlaneRegions:
    - fsn1
  hetznerSecretRef:
    name: cluster-api-hetzner
    key:
      hcloudToken: hcloud-token
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachineDeployment
metadata:
  name: shana
  namespace: default
spec:
  clusterName: shana
  replicas: 1
  selector:
    matchLabels:
      cluster.x-k8s.io/cluster-name: shana
      pool: worker-pool-1
  template:
    metadata:
      labels:
        cluster.x-k8s.io/cluster-name: shana
        pool: worker-pool-1
    spec:
      bootstrap:
        configRef:
          apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
          kind: RKE2ConfigTemplate
          name: shana-machine-config
      clusterName: shana
      failureDomain: fsn1
      infrastructureRef:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: HCloudMachineTemplate
        name: shana
---
apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: RKE2ConfigTemplate
metadata:
  name: shana-machine-config
spec:
  template:
    spec: {}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: HCloudMachineTemplate
metadata:
  name: shana
  namespace: default
spec:
  template:
    spec:
      imageName: debian-12
      type: cax11
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachineHealthCheck
metadata:
  name: shana-worker-unhealthy-5m
  namespace: default
spec:
  clusterName: shana
  maxUnhealthy: 100%
  nodeStartupTimeout: 10m
  remediationTemplate:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    kind: HCloudRemediationTemplate
    name: shana-worker
  selector:
    matchLabels:
      nodepool: shana-0
  unhealthyConditions:
  - status: Unknown
    timeout: 180s
    type: Ready
  - status: "False"
    timeout: 180s
    type: Ready
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: HCloudRemediationTemplate
metadata:
  name: shana-worker
  namespace: default
spec:
  template:
    spec:
      strategy:
        retryLimit: 1
        timeout: 180s
        type: Reboot