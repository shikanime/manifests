apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: RKE2ControlPlane
metadata:
  name: shana-control-plane
  namespace: default
spec:
  agentConfig:
    kubelet:
      extraArgs:
        - --cloud-provider=external
  files:
    - path: /var/lib/rancher/rke2/server/manifests/hcloud-cloud-controller-manager.yaml
      owner: root:root
      permissions: "0600"
      contentFrom:
        secret:
          name: rke2-hetzner-manifest
          key: hcloud-cloud-controller-manager.yaml
    - path: /var/lib/rancher/rke2/server/manifests/hcloud-csi.yaml
      owner: root:root
      permissions: "0600"
      contentFrom:
        secret:
          name: rke2-hetzner-manifest
          key: hcloud-csi.yaml
    - path: /var/lib/rancher/rke2/server/manifests/hetzner.yaml
      owner: root:root
      permissions: "0600"
      contentFrom:
        secret:
          name: rke2-hetzner-manifest
          key: hetzner.yaml
    - path: /var/lib/rancher/rke2/server/manifests/tailscale-operator.yaml
      owner: root:root
      permissions: "0600"
      contentFrom:
        secret:
          name: rke2-tailscale-manifest
          key: tailscale-operator.yaml
  machineTemplate:
    infrastructureRef:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
      kind: HCloudMachineTemplate
      name: shana-control-plane
  preRKE2Commands:
    - sleep 30 #fix to give OS time to become ready
  registrationMethod: internal-first
  replicas: 3
  rolloutStrategy:
    rollingUpdate:
      maxSurge: 1
  serverConfig:
    disableComponents:
      kubernetesComponents:
        - cloudController
  version: v1.31.7+rke2r1
