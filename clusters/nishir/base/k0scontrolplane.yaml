apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: K0sControlPlane
metadata:
  name: nishir
spec:
  version: v1.33.3+k0s.0
  replicas: 1
  machineTemplate:
    infrastructureRef:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
      kind: RemoteMachineTemplate
      name: nishir
  k0sConfigSpec:
    args:
      - --enable-worker
      - --no-taints
    k0s:
      apiVersion: k0s.k0sproject.io/v1beta1
      kind: ClusterConfig
      metadata:
        name: nishir
      spec:
        extensions:
          helm:
            repositories:
              - name: fairwinds-stable
                url: https://charts.fairwinds.com/stable
              - name: jetstack
                url: https://charts.jetstack.io
              - name: kubernetes-sigs-cluster-api-operator
                url: https://kubernetes-sigs.github.io/cluster-api-operator
              - name: kubernetes-sigs-descheduler
                url: https://kubernetes-sigs.github.io/descheduler
              - name: kubernetes-sigs-nfd
                url: https://kubernetes-sigs.github.io/node-feature-discovery/charts
              - name: longhorn
                url: https://charts.longhorn.io
              - name: tailscale
                url: https://pkgs.tailscale.com/helmcharts
            charts:
              - name: cert-manager
                chartname: jetstack/cert-manager
                version: "v1.18.2"
                namespace: cert-manager
                values: |
                  crds:
                    enabled: true
              - name: cluster-api-operator
                chartname: kubernetes-sigs-cluster-api-operator/cluster-api-operator
                version: "0.21.0"
                namespace: capi-operator-system
                values: |
                  bootstrap:
                    k0sproject-k0smotron: {}
                  controlPlane:
                    k0sproject-k0smotron: {}
                  infrastructure:
                    hetzner: {}
                    k0sproject-k0smotron: {}
                  cert-manager:
                    enabled: true
              - name: descheduler
                chartname: kubernetes-sigs-descheduler/descheduler
                version: "0.33.0"
                namespace: kube-system
                values: |
                  deschedulerPolicy:
                    metricsCollector:
                      enabled: true
                    profiles:
                      - name: default
                        pluginConfig:
                          - name: DefaultEvictor
                            args:
                              ignorePvcPods: true
                              evictLocalStoragePods: false
                          - name: HighNodeUtilization
                            args:
                              thresholds:
                                cpu: 20
                                memory: 20
                                pods: 20
              - name: tailscale-operator
                chartname: tailscale/tailscale-operator
                version: "1.76.1"
                namespace: tailscale
                values: |
                  oauthSecretVolume:
                    secret:
                      secretName: oauth-client
                  operatorConfig:
                    hostname: nishir-k8s-operator
    preInstalledK0s: true
