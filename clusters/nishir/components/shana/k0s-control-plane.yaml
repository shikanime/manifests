apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: K0sControlPlane
metadata:
  name: shana
  namespace: nishir
spec:
  machineTemplate:
    infrastructureRef:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
      kind: HCloudMachineTemplate
      name: shana-control-plane
  k0sConfigSpec:
    k0s:
      apiVersion: k0s.k0sproject.io/v1beta1
      kind: ClusterConfig
      metadata:
        name: k0s
      spec:
        api:
          port: 6443
          extraArgs:
            anonymous-auth: "true"
        extensions:
          helm:
            repositories:
              - name: fairwinds-stable
                url: https://charts.fairwinds.com/stable
              - name: hcloud
                url: https://charts.hetzner.cloud
              - name: kubernetes-sigs-descheduler
                url: https://kubernetes-sigs.github.io/descheduler
            charts:
              - name: descheduler
                chartname: kubernetes-sigs-descheduler/descheduler
                version: "0.33.0"
                namespace: kube-system
                values: |
                  deschedulerPolicy:
                    metricsCollector:
                      enabled: true
                    profiles:
                      - name: default
                        pluginConfig:
                          - name: DefaultEvictor
                            args:
                              ignorePvcPods: true
                              evictLocalStoragePods: false
                          - name: HighNodeUtilization
                            args:
                              thresholds:
                                cpu: 20
                                memory: 20
                                pods: 20
                          - name: LowNodeUtilization
                            args:
                              thresholds:
                                cpu: 60
                                memory: 60
                                pods: 60
                              targetThresholds:
                                cpu: 80
                                memory: 80
                                pods: 80
                              metricsUtilization:
                                source: KubernetesMetrics
                          - name: RemoveDuplicates
                          - name: RemovePodsHavingTooManyRestarts
                            args:
                              podRestartThreshold: 50
                              includingInitContainers: true
                          - name: RemovePodsViolatingInterPodAntiAffinity
                          - name: RemovePodsViolatingNodeAffinity
                            args:
                              nodeAffinityType:
                                - requiredDuringSchedulingIgnoredDuringExecution
                          - name: RemovePodsViolatingNodeTaints
                          - name: RemovePodsViolatingTopologySpreadConstraint
                        plugins:
                          balance:
                            enabled:
                              - HighNodeUtilization
                              - LowNodeUtilization
                              - RemoveDuplicates
                              - RemovePodsViolatingTopologySpreadConstraint
                          deschedule:
                            enabled:
                              - RemovePodsHavingTooManyRestarts
                              - RemovePodsViolatingInterPodAntiAffinity
                              - RemovePodsViolatingNodeAffinity
                              - RemovePodsViolatingNodeTaints
              - name: hcloud-cloud-controller-manager
                chartname: hcloud/hcloud-cloud-controller-manager
                version: "1.21.0"
                namespace: kube-system
                values: |
                  networking:
                    enabled: true
                  metrics:
                    enabled: true
              - name: vpa
                chartname: fairwinds-stable/vpa
                version: "4.9.0"
                namespace: kube-system
        network:
          kuberouter:
            extraArgs:
              advertise-cluster-ip: "true"
              advertise-external-ip: "true"
              advertise-loadbalancer-ip: "true"
  replicas: 1
  version: v1.33.3+k0s.0
