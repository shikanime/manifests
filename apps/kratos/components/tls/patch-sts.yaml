apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kratos
  namespace: shikanime
spec:
  template:
    spec:
      containers:
        - name: kratos
          ports:
            - containerPort: 4433
              name: https
            - containerPort: 4434
              name: https-admin
          readinessProbe:
            httpGet:
              port: https-admin
              scheme: HTTPS
          livenessProbe:
            httpGet:
              port: https-admin
              scheme: HTTPS
          startupProbe:
            httpGet:
              port: https-admin
              scheme: HTTPS
          volumeMounts:
            - name: certs
              mountPath: /etc/ssl/certs
              readOnly: true
            - name: tls
              mountPath: /etc/ssl/private
              readOnly: true
      initContainers:
        - name: migrate
          volumeMounts:
            - name: certs
              mountPath: /etc/ssl/certs
              readOnly: true
            - name: tls
              mountPath: /etc/ssl/private
              readOnly: true
      volumes:
        - name: certs
          projected:
            sources:
            - configMap:
                name: nishir-ca-certificates.crt
                items:
                - key: ca-certificates.crt
                  path: ca-certificates.crt
            - secret:
                name: kratos-postgres-client
                items:
                - key: ca.crt
                  path: ca.crt
        - name: tls
          projected:
            sources:
            - secret:
                name: kratos-tls
                items:
                - key: tls.crt
                  path: tls.crt
                - key: tls.key
                  path: tls.key
            - secret:
                name: kratos-postgres-client
                items:
                - key: tls.crt
                  path: postgres-client.crt
                - key: tls.key
                  path: postgres-client.key
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kratos-postgres
  namespace: shikanime
spec:
  template:
    spec:
      containers:
        - name: postgres
          volumeMounts:
            - name: certs
              mountPath: /etc/ssl/certs
              readOnly: true
            - name: tls
              mountPath: /etc/ssl/private
              readOnly: true
      volumes:
        - name: certs
          configMap:
            name: nishir-ca-certificates.crt
        - name: tls
          secret:
            secretName: kratos-postgres-tls
            items:
              - key: tls.crt
                path: tls.crt
                mode: 0644
              - key: tls.key
                path: tls.key
                mode: 0640
